<div class="esims-container">
  <!-- Header Section -->
  <div class="esims-header">
    <div class="header-content">
      <div class="header-title-section">
        <h1 class="page-title">üì± Gestion des eSIMs</h1>
        <p class="page-subtitle">G√©rez et surveillez vos {{ filteredEsims.length || 0 }} eSIMs import√©es depuis Console Connect</p>
      </div>
      <div class="header-actions">
        <button class="btn-view-toggle" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'" title="Vue grille">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
        </button>
        <button class="btn-view-toggle" [class.active]="viewMode === 'table'" (click)="viewMode = 'table'" title="Vue tableau">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </button>
        <button class="btn-refresh" (click)="loadEsims(page)" title="Actualiser">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid" *ngIf="stats">
      <div class="stat-card stat-total">
        <div class="stat-icon">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ stats.total || 0 }}</div>
          <div class="stat-label">Total eSIMs</div>
        </div>
      </div>
      
      <div class="stat-card stat-assigned">
        <div class="stat-icon">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ stats.assigned || 0 }}</div>
          <div class="stat-label">Assign√©es</div>
        </div>
      </div>
      
      <div class="stat-card stat-unassigned">
        <div class="stat-icon">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ stats.unassigned || 0 }}</div>
          <div class="stat-label">Non assign√©es</div>
        </div>
      </div>
      
      <div class="stat-card stat-recent">
        <div class="stat-icon">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ stats.recently_assigned || 0 }}</div>
          <div class="stat-label">Cette semaine</div>
        </div>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-wrapper">
      <div class="search-input-wrapper">
        <div class="search-icon">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input 
          type="text" 
          class="search-input"
          name="searchTerm"
          placeholder="Rechercher par ICCID, code d'activation, LPA, package..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
        <button *ngIf="searchTerm" class="search-clear" (click)="searchTerm = ''; loadEsims(1)" title="Effacer">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <select class="items-per-page-select" (change)="onItemsPerPageChange($any($event.target).value)" [value]="itemsPerPage">
        <option [value]="15">15 par page</option>
        <option [value]="25">25 par page</option>
        <option [value]="50">50 par page</option>
        <option [value]="100">100 par page</option>
      </select>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error">
    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    {{ error }}
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Chargement des eSIMs...</p>
  </div>

  <!-- Vue Grille (Grid) -->
  <div *ngIf="viewMode === 'grid' && !loading" class="esims-grid">
    <div *ngFor="let esim of filteredEsims" class="esim-card">
      <div class="esim-card-header">
        <div class="esim-id-badge">#{{ esim.id }}</div>
        <span [ngClass]="'status-badge ' + getAssignmentBadgeClass(esim.is_assigned)">
          {{ esim.is_assigned ? 'Assign√©e' : 'Disponible' }}
        </span>
      </div>
      
      <div class="esim-card-body">
        <div class="esim-iccid-section">
          <div class="iccid-label">ICCID</div>
          <div class="iccid-value">
            <code class="code-text">{{ truncateText(esim.iccid, 24) }}</code>
            <button class="copy-icon-btn" (click)="copyToClipboard(esim.iccid, 'ICCID')" title="Copier ICCID">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
          </div>
        </div>

        <div class="esim-details">
          <div class="detail-item">
            <div class="detail-icon activation-icon">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <div class="detail-content">
              <span class="detail-label">Code d'activation</span>
              <div class="detail-value-wrapper">
                <code class="code-text-small">{{ truncateText(esim.activation_code, 16) }}</code>
                <button class="copy-small-btn" (click)="copyToClipboard(esim.activation_code, 'Code d\'activation')" title="Copier">
                  <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon lpa-icon">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
            </div>
            <div class="detail-content">
              <span class="detail-label">LPA</span>
              <div class="detail-value-wrapper">
                <code class="code-text-small">{{ truncateText(esim.lpa, 20) }}</code>
                <button class="copy-small-btn" (click)="copyToClipboard(esim.lpa, 'LPA')" title="Copier">
                  <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="detail-item" *ngIf="esim.esim_package">
            <div class="detail-icon package-icon">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div class="detail-content">
              <span class="detail-label">Package</span>
              <span class="detail-value">{{ getPackageName(esim) }}</span>
              <span class="detail-subvalue" *ngIf="esim.esim_package?.destination">{{ getPackageDestination(esim) }}</span>
            </div>
          </div>
        </div>

        <div class="esim-footer">
          <div class="footer-item" *ngIf="esim.assigned_at">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Assign√©e le {{ formatDate(esim.assigned_at) }}</span>
          </div>
          <div class="footer-item">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Cr√©√©e le {{ formatDate(esim.created_at) }}</span>
          </div>
        </div>
      </div>

      <div class="esim-card-actions">
        <button class="btn-action btn-edit" (click)="editEsim(esim)" title="Modifier">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Modifier
        </button>
        <button class="btn-action btn-delete" (click)="deleteEsim(esim.id)" title="Supprimer">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Supprimer
        </button>
      </div>
    </div>

    <!-- Message vide -->
    <div *ngIf="filteredEsims.length === 0" class="empty-state">
      <div class="empty-icon">üì±</div>
      <h3>Aucune eSIM trouv√©e</h3>
      <p>{{ searchTerm ? 'Aucun r√©sultat pour votre recherche.' : 'Aucune eSIM disponible pour le moment.' }}</p>
    </div>
  </div>

  <!-- Vue Tableau (Table) -->
  <div *ngIf="viewMode === 'table' && !loading" class="esims-table-wrapper">
    <table class="esims-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ICCID</th>
          <th>Code d'activation</th>
          <th>LPA</th>
          <th>Package</th>
          <th>Statut</th>
          <th>Assign√©e le</th>
          <th>Cr√©√©e le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let esim of filteredEsims">
          <td class="esim-id">{{ esim.id }}</td>
          <td class="iccid-cell-table">
            <div class="code-cell">
              <code>{{ truncateText(esim.iccid, 20) }}</code>
              <button class="copy-cell-btn" (click)="copyToClipboard(esim.iccid, 'ICCID')" title="Copier">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </td>
          <td class="activation-cell-table">
            <div class="code-cell">
              <code>{{ truncateText(esim.activation_code, 16) }}</code>
              <button class="copy-cell-btn" (click)="copyToClipboard(esim.activation_code, 'Code')" title="Copier">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </td>
          <td class="lpa-cell-table">
            <div class="code-cell">
              <code>{{ truncateText(esim.lpa, 18) }}</code>
              <button class="copy-cell-btn" (click)="copyToClipboard(esim.lpa, 'LPA')" title="Copier">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </td>
          <td>
            <span class="package-badge" *ngIf="esim.esim_package">{{ getPackageName(esim) }}</span>
            <span class="no-package-badge" *ngIf="!esim.esim_package">Non assign√©e</span>
          </td>
          <td>
            <span [ngClass]="'status-badge ' + getAssignmentBadgeClass(esim.is_assigned)">
              {{ esim.is_assigned ? 'Assign√©e' : 'Disponible' }}
            </span>
          </td>
          <td class="date-cell">{{ formatDate(esim.assigned_at) }}</td>
          <td class="date-cell">{{ formatDate(esim.created_at) }}</td>
          <td class="actions-cell">
            <button class="btn-action-small btn-edit" (click)="editEsim(esim)" title="Modifier">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
            <button class="btn-action-small btn-delete" (click)="deleteEsim(esim.id)" title="Supprimer">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Message vide pour vue tableau -->
    <div *ngIf="filteredEsims.length === 0" class="empty-state">
      <div class="empty-icon">üì±</div>
      <h3>Aucune eSIM trouv√©e</h3>
      <p>{{ searchTerm ? 'Aucun r√©sultat pour votre recherche.' : 'Aucune eSIM disponible pour le moment.' }}</p>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="pagination && pagination.total > 0" class="pagination-wrapper">
    <div class="pagination-info">
      <span>Affichage de <strong>{{ pagination.from || 0 }}</strong> √† <strong>{{ pagination.to || 0 }}</strong> sur <strong>{{ pagination.total }}</strong> eSIMs</span>
      <span class="pagination-page-info">Page <strong>{{ pagination.current_page }}</strong> sur <strong>{{ pagination.last_page }}</strong></span>
    </div>
    <div class="pagination-controls-custom">
      <button 
        class="pagination-btn pagination-first" 
        [disabled]="pagination.current_page === 1"
        (click)="onPageChange(1)"
        title="Premi√®re page"
      >
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
        </svg>
      </button>
      <button 
        class="pagination-btn" 
        [disabled]="pagination.current_page === 1"
        (click)="onPageChange(pagination.current_page - 1)"
        title="Page pr√©c√©dente"
      >
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Pr√©c√©dent
      </button>
      
      <div class="pagination-pages">
        <button
          *ngFor="let pageNum of getPageNumbers()"
          [class.active]="pageNum === pagination.current_page"
          [class.ellipsis]="pageNum === -1"
          class="pagination-page-btn"
          (click)="pageNum !== -1 && onPageChange(pageNum)"
          [disabled]="pageNum === -1"
        >
          {{ pageNum === -1 ? '...' : pageNum }}
        </button>
      </div>
      
      <button 
        class="pagination-btn" 
        [disabled]="pagination.current_page >= pagination.last_page"
        (click)="onPageChange(pagination.current_page + 1)"
        title="Page suivante"
      >
        Suivant
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <button 
        class="pagination-btn pagination-last" 
        [disabled]="pagination.current_page >= pagination.last_page"
        (click)="onPageChange(pagination.last_page)"
        title="Derni√®re page"
      >
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Modal d'√©dition -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Modifier l'eSIM #{{ selectedEsim?.id }}</h2>
      <button class="modal-close" (click)="closeEditModal()">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedEsim">
      <form (ngSubmit)="updateEsimStatus()">
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="is_assigned" [(ngModel)]="selectedEsim.is_assigned">
            <span>eSIM assign√©e</span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date d'assignation</label>
          <input 
            type="datetime-local" 
            name="assigned_at" 
            [value]="getDateTimeLocalValue(selectedEsim.assigned_at)"
            (input)="onDateTimeChange($any($event.target).value)"
            class="form-input"
          >
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeEditModal()">Annuler</button>
          <button type="submit" class="btn-primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>
</div>
